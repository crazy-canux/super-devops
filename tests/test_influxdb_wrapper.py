import unittest

from super_devops.tick_stack.influxdb_wrapper import BaseInfluxdb


class InfluxdbTestCase(unittest.TestCase):
    @unittest.skip('ignore')
    def test_check_database_exist(self):
        result = BaseInfluxdb().check_database_exist("devops")
        self.assertEqual(True, result, msg="check database exist failed.")

    @unittest.skip('ignore')
    def test_create_database(self):
        result = BaseInfluxdb().create_database("sandboxav")
        self.assertEqual(True, result, msg="create database failed.")

    @unittest.skip('ignore')
    def test_create_rp(self):
        result = BaseInfluxdb().create_retention_policy(
            "sandboxav", "sandboxav", "30d", 2, True
        )
        self.assertEqual(True, result, msg="create rp failed.")

    def test_query(self):
        ifql = """
        SELECT 100 - mean("usage_idle") AS "idle" 
        FROM "cpu" 
        WHERE "cpu" = 'cpu-total' AND  time > now() - 5m
        GROUP BY time(1m), "host" fill(none)
        """
        result = BaseInfluxdb().query("devops", ifql)
        self.assertIsNotNone(result, 'select failed.')
        """
        {'results': [{'statement_id': 0, 'series': [{'name': 'cpu', 'tags': {'host': 'AT-MySQL'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 0.03125586093945287], ['2019-11-19T09:40:00Z', 0.03958997499701411], ['2019-11-19T09:41:00Z', 0.04375117218303615], ['2019-11-19T09:42:00Z', 0.04583723990482724], ['2019-11-19T09:43:00Z', 0.04167330867234398], ['2019-11-19T09:44:00Z', 0.04688125038921953]]}, {'name': 'cpu', 'tags': {'host': 'AT-Rabbitmq-Haproxy'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 0.2501250627643259], ['2019-11-19T09:40:00Z', 0.2669670173403347], ['2019-11-19T09:41:00Z', 0.35020860447122004], ['2019-11-19T09:42:00Z', 0.300250225104719], ['2019-11-19T09:43:00Z', 0.31704212966837986], ['2019-11-19T09:44:00Z', 0.37507522549957173]]}, {'name': 'cpu', 'tags': {'host': 'AT-Rabbitmq01'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 0.4509018040227346], ['2019-11-19T09:40:00Z', 0.48381715054661356], ['2019-11-19T09:41:00Z', 0.583450116553351], ['2019-11-19T09:42:00Z', 0.5669502336797478], ['2019-11-19T09:43:00Z', 0.5671756715035485], ['2019-11-19T09:44:00Z', 0.47571357079544896]]}, {'name': 'cpu', 'tags': {'host': 'AT-Rabbitmq02'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 0.15022533814712347], ['2019-11-19T09:40:00Z', 0.33358354216329644], ['2019-11-19T09:41:00Z', 0.38348345841518494], ['2019-11-19T09:42:00Z', 0.36691691687042294], ['2019-11-19T09:43:00Z', 0.4001001000847708], ['2019-11-19T09:44:00Z', 0.40028773124370787]]}, {'name': 'cpu', 'tags': {'host': 'AT-Redis'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 0.05003752819244767], ['2019-11-19T09:40:00Z', 0.141675032254156], ['2019-11-19T09:41:00Z', 0.11671252617077243], ['2019-11-19T09:42:00Z', 0.14165005411926757], ['2019-11-19T09:43:00Z', 0.10837710878057294], ['2019-11-19T09:44:00Z', 0.16255001763602195]]}, {'name': 'cpu', 'tags': {'host': 'backup-server'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 1.587996248276184], ['2019-11-19T09:40:00Z', 1.1777606965329852], ['2019-11-19T09:41:00Z', 1.2629336351638472], ['2019-11-19T09:42:00Z', 1.240201263942751], ['2019-11-19T09:43:00Z', 1.127428122710569], ['2019-11-19T09:44:00Z', 1.22249467921921]]}, {'name': 'cpu', 'tags': {'host': 'gitlab'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 3.8281103402784424], ['2019-11-19T09:40:00Z', 3.311290865158], ['2019-11-19T09:41:00Z', 3.5475162263316946], ['2019-11-19T09:42:00Z', 3.353584195154781], ['2019-11-19T09:43:00Z', 3.336089292237105], ['2019-11-19T09:44:00Z', 2.692893340444357]]}, {'name': 'cpu', 'tags': {'host': 'jenkins'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 0.1626524865668415], ['2019-11-19T09:40:00Z', 0.11885217371116141], ['2019-11-19T09:41:00Z', 0.1063542732930074], ['2019-11-19T09:42:00Z', 0.1125980023593911], ['2019-11-19T09:43:00Z', 0.10843003414701968], ['2019-11-19T09:44:00Z', 0.07194264214393797]]}, {'name': 'cpu', 'tags': {'host': 'repo-ubuntu16'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 16.326416465400754], ['2019-11-19T09:40:00Z', 16.987985865078528], ['2019-11-19T09:41:00Z', 16.027362414904218], ['2019-11-19T09:42:00Z', 15.930524600712772], ['2019-11-19T09:43:00Z', 16.177572516879493], ['2019-11-19T09:44:00Z', 18.010139417063854]]}, {'name': 'cpu', 'tags': {'host': 'research'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 30.47511595803742], ['2019-11-19T09:40:00Z', 36.42952133947917], ['2019-11-19T09:41:00Z', 24.29001018455432], ['2019-11-19T09:42:00Z', 3.689162605377419], ['2019-11-19T09:43:00Z', 9.95440521676737], ['2019-11-19T09:44:00Z', 12.720892342859742]]}, {'name': 'cpu', 'tags': {'host': 'samples'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 1.1638092845018377], ['2019-11-19T09:40:00Z', 1.5474272887059897], ['2019-11-19T09:41:00Z', 1.5473625546416798], ['2019-11-19T09:42:00Z', 1.3978749994601003], ['2019-11-19T09:43:00Z', 1.2135650349546694], ['2019-11-19T09:44:00Z', 1.4077570875834908]]}, {'name': 'cpu', 'tags': {'host': 'soniclinux-repo'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 0.5005004986481225], ['2019-11-19T09:40:00Z', 0.4839175766902031], ['2019-11-19T09:41:00Z', 0.8690839841601843], ['2019-11-19T09:42:00Z', 0.6685232929676204], ['2019-11-19T09:43:00Z', 1.0696469107433728], ['2019-11-19T09:44:00Z', 0.5005004986481225]]}, {'name': 'cpu', 'tags': {'host': 'workstation'}, 'columns': ['time', 'idle'], 'values': [['2019-11-19T09:39:00Z', 2.6376720900224626], ['2019-11-19T09:40:00Z', 2.71707167977236], ['2019-11-19T09:41:00Z', 7.531748826701985], ['2019-11-19T09:42:00Z', 9.060651847100033], ['2019-11-19T09:43:00Z', 7.538644905142789], ['2019-11-19T09:44:00Z', 2.6209794663899117]]}]}]}
        """


if __name__ == "__main__":
    unittest.main()
